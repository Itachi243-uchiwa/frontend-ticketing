@if (loading()) {
  <div class="loading-screen">
    <div class="spinner"></div>
    <p class="loading-label">Chargement...</p>
  </div>

} @else if (order()) {
  <div class="checkout-page">
    <div class="checkout-container">

      <!-- ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ -->
      <div class="checkout-header">
        <h1 class="checkout-title">Finaliser votre commande</h1>
        <p class="checkout-order-num">Commande #{{ order()!.orderNumber }}</p>
        <div class="timer-pill">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Temps restant : {{ getTimeRemaining() }}
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ Stepper ‚îÄ‚îÄ‚îÄ -->
      <div class="stepper-wrap">
        <div class="step-circle" [class.step-active]="currentStep() >= 1" [class.step-inactive]="currentStep() < 1">1</div>
        <div class="step-connector" [class.connector-active]="currentStep() >= 2" [class.connector-inactive]="currentStep() < 2"></div>
        <div class="step-circle" [class.step-active]="currentStep() >= 2" [class.step-inactive]="currentStep() < 2">2</div>
      </div>
      <div class="stepper-labels">
        <span class="step-label" [class.step-label-active]="currentStep() === 1">Informations</span>
        <span class="step-label" [class.step-label-active]="currentStep() === 2">Paiement</span>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ Grid ‚îÄ‚îÄ‚îÄ -->
      <div class="checkout-grid">

        <!-- Left: Form -->
        <div>
          <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">

            <!-- Step 1: Billing -->
            @if (currentStep() === 1) {
              <div class="form-card">
                <div class="form-card-header">
                  <div class="form-accent"></div>
                  <h2 class="form-card-title">Informations de facturation</h2>
                </div>
                <div class="form-body">

                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">Pr√©nom <span class="required">*</span></label>
                      <input type="text" class="form-input" formControlName="firstName" placeholder="Jean">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Nom <span class="required">*</span></label>
                      <input type="text" class="form-input" formControlName="lastName" placeholder="Dupont">
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Email <span class="required">*</span></label>
                    <input type="email" class="form-input" formControlName="email" placeholder="jean@exemple.com">
                  </div>

                  <div class="form-group">
                    <label class="form-label">T√©l√©phone <span style="color:var(--text-3); font-weight:400; text-transform:none;">(optionnel)</span></label>
                    <input type="tel" class="form-input" formControlName="phone" placeholder="+33 6 12 34 56 78">
                  </div>

                  <div class="form-nav form-nav-right">
                    <button type="button" class="btn-next" (click)="nextStep()" [disabled]="!isBillingValid()">
                      Continuer vers le paiement
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            }

            <!-- Step 2: Payment -->
            @if (currentStep() === 2) {
              <div class="form-card">
                <div class="form-card-header">
                  <div class="form-accent"></div>
                  <h2 class="form-card-title">M√©thode de paiement</h2>
                </div>
                <div class="form-body">

                  <div class="payment-options">
                    @for (method of paymentMethods; track method.value) {
                      <label
                        class="payment-option"
                        [class.selected]="checkoutForm.get('paymentMethod')?.value === method.value">
                        <input
                          type="radio"
                          class="payment-radio"
                          formControlName="paymentMethod"
                          [value]="method.value">
                        <span class="payment-icon">{{ method.icon }}</span>
                        <span class="payment-label">{{ method.label }}</span>
                      </label>
                    }
                  </div>

                  <div class="security-box">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <div>
                      <p class="security-title">Paiement s√©curis√©</p>
                      <p class="security-text">Vos informations sont prot√©g√©es et crypt√©es</p>
                    </div>
                  </div>

                  <div class="terms-row">
                    <input type="checkbox" class="terms-checkbox" formControlName="acceptTerms">
                    <label class="terms-label">
                      J'accepte les <a href="#" class="terms-link">conditions g√©n√©rales de vente</a>
                      et la <a href="#" class="terms-link">politique de confidentialit√©</a>
                      <span class="required">*</span>
                    </label>
                  </div>

                  <div class="form-nav">
                    <button type="button" class="btn-back" (click)="previousStep()">
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                      </svg>
                      Retour
                    </button>
                    <button
                      type="submit"
                      class="btn-pay"
                      [disabled]="checkoutForm.invalid || isProcessing()">
                      @if (isProcessing()) {
                        <span style="width:16px;height:16px;border:2px solid rgba(8,12,24,0.3);border-top-color:#080C18;border-radius:50%;animation:spin 0.6s linear infinite;display:inline-block;"></span>
                        Traitement...
                      } @else {
                        üîí Payer {{ order()!.total }}‚Ç¨
                      }
                    </button>
                  </div>

                </div>
              </div>
            }

          </form>
        </div>

        <!-- Right: Summary -->
        <div>
          <div class="summary-sticky">
            <div class="summary-card">
              <div class="summary-header">
                <h2 class="summary-title">üìã R√©capitulatif</h2>
              </div>
              <div class="summary-body">

                <div class="summary-items">
                  @for (item of order()!.items; track item.id) {
                    <div class="summary-item">
                      <div>
                        <p class="item-name">{{ item.ticketType.name }}</p>
                        <p class="item-qty">{{ item.quantity }} √ó {{ item.unitPrice }}‚Ç¨</p>
                      </div>
                      <p class="item-price">{{ item.subtotal }}‚Ç¨</p>
                    </div>
                  }
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row">
                  <span>Sous-total</span>
                  <span>{{ order()!.subtotal }}‚Ç¨</span>
                </div>

                @if (order()!.discount > 0) {
                  <div class="summary-row">
                    <span>R√©duction</span>
                    <span class="summary-discount">-{{ order()!.discount }}‚Ç¨</span>
                  </div>
                }
                @if (order()!.tax > 0) {
                  <div class="summary-row">
                    <span>TVA</span>
                    <span>{{ order()!.tax }}‚Ç¨</span>
                  </div>
                }

                <div class="summary-divider"></div>

                <div class="summary-total-row">
                  <span class="total-label">Total</span>
                  <span class="total-amount">{{ order()!.total }}‚Ç¨</span>
                </div>

                <div class="security-badges">
                  <div class="sec-badge">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    SSL
                  </div>
                  <div class="sec-badge">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    Crypt√©
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
}
